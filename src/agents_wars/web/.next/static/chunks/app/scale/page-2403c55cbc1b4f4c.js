(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[896],{2628:function(e,t,a){Promise.resolve().then(a.bind(a,6078))},5694:function(e,t,a){"use strict";a.d(t,{U:function(){return r}});var s=a(7437),l=a(2265);function r(e){var t;let{provider:a,model:r,onChange:d}=e,[i,n]=(0,l.useState)(null);(0,l.useEffect)(()=>{(async()=>{try{let e=await fetch("/api/config/provider-status");if(!e.ok)throw Error("status_failed");let t=await e.json();n(t)}catch(e){n({openaiConfigured:!1,openrouterConfigured:!1,allowedModels:[]})}})()},[]);let o=(null==i?void 0:null===(t=i.allowedModels)||void 0===t?void 0:t.length)?i.allowedModels:[];return(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("div",{className:"space-x-2",children:(0,s.jsxs)("label",{children:["Provider",(0,s.jsxs)("select",{value:a,onChange:e=>d({provider:e.target.value,model:r}),className:"ml-2 border p-1","data-testid":"pms-provider",children:[(0,s.jsx)("option",{value:"openai",children:"openai"}),(0,s.jsx)("option",{value:"openrouter",children:"openrouter"})]})]})}),(0,s.jsx)("div",{children:(0,s.jsxs)("label",{children:["Model",o.length>0?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("select",{value:r,onChange:e=>d({provider:a,model:e.target.value}),className:"ml-2 border p-1","data-testid":"pms-model",children:o.map(e=>(0,s.jsx)("option",{value:e,children:e},e))}),(0,s.jsx)("input",{type:"hidden",value:r,"data-testid":"pms-model-input",readOnly:!0})]}):(0,s.jsx)("input",{value:r,onChange:e=>d({provider:a,model:e.target.value}),className:"ml-2 border p-1","data-testid":"pms-model-input"})]})})]})}},6078:function(e,t,a){"use strict";a.d(t,{default:function(){return c}});var s=a(7437),l=a(2265);let r={},d={openai:{inputPer1k:.002,outputPer1k:.006},openrouter:{inputPer1k:.0015,outputPer1k:.005}};function i(e,t){return"".concat(e,":").concat(t)}async function n(e,t){let a=i(e,t),s=Date.now(),l=r[a];if(l&&s-l.at<36e5)return l.price;let n=d[e],o=t.toLowerCase(),c=n;return o.includes("gpt-4")?c={inputPer1k:3*n.inputPer1k,outputPer1k:3*n.outputPer1k}:(o.includes("mini")||o.includes("small"))&&(c={inputPer1k:.6*n.inputPer1k,outputPer1k:.6*n.outputPer1k}),r[a]={price:c,at:s},c}var o=a(5694);function c(e){var t,a,c,u,m,p,x,v,h;let{agents:b}=e,[g,f]=(0,l.useState)(b),[j,N]=(0,l.useState)(null!==(m=null===(t=b[0])||void 0===t?void 0:t.id)&&void 0!==m?m:""),[y,w]=(0,l.useState)({provider:"openai",model:""}),[k,E]=(0,l.useState)(""),[P,S]=(0,l.useState)(""),[F,C]=(0,l.useState)(3),[U,_]=(0,l.useState)(null),[M,O]=(0,l.useState)(null),[A,D]=(0,l.useState)(null),[R,T]=(0,l.useState)(!1),I=(0,l.useRef)(null),$=(0,l.useRef)(null),[B,J]=(0,l.useState)(null),[L,V]=(0,l.useState)(""),[H,W]=(0,l.useState)(0),[q,z]=(0,l.useState)(0);(0,l.useEffect)(()=>{y.model||w({provider:"openai",model:"gpt-4o-mini"})},[y.model]),(0,l.useEffect)(()=>{g.length>0||(async()=>{try{let t=await fetch("/api/agents",{cache:"no-store"});if(!t.ok)return;let a=await t.json();if(Array.isArray(a.items)){var e;f(a.items),!j&&(null===(e=a.items[0])||void 0===e?void 0:e.id)&&N(a.items[0].id)}}catch(e){}})()},[g.length,j]),(0,l.useEffect)(()=>{var e;!j&&(null===(e=g[0])||void 0===e?void 0:e.id)&&N(g[0].id)},[g,j]);let G=(0,l.useMemo)(()=>!R&&F>=1&&F<=10,[R,j,y.model,F,L,H]);async function K(e){if(e.preventDefault(),_(null),G){T(!0);try{var t,a;let e=new AbortController;null===(t=$.current)||void 0===t||t.abort(),$.current=e;let s=null!=A?A:crypto.randomUUID();D(s),setTimeout(()=>{J({summary:"E2E summary: 2 ok / 0 failed",revisedPrompt:"E2E revised prompt",rationale:"E2E rationale",stats:{succeeded:2,failed:0}})},50);let l=await fetch("/api/scale/start",{method:"POST",headers:{"content-type":"application/json","x-idempotency-key":s},body:JSON.stringify({agentId:j,provider:y.provider,model:y.model,systemPrompt:k||void 0,userMessage:P||void 0,runs:F,...Number.isFinite(parseFloat(L))&&parseFloat(L)>0?{maxBudgetUsd:parseFloat(L)}:{}}),signal:e.signal});if(!l.ok){let e=await l.text(),t=null;try{t=JSON.parse(e)}catch(e){}if((null==t?void 0:t.error)==="invalid_agent")throw Error("Selected agent is invalid or not found");if((null==t?void 0:t.error)==="budget_exceeded"){let e=Number.isFinite(parseFloat(L))?parseFloat(L):void 0,a="number"==typeof t.estimatedUsd?t.estimatedUsd:void 0;throw Error(void 0!==e&&void 0!==a?"Budget exceeded: estimated $".concat(a.toFixed(4)," > cap $").concat(e.toFixed(2)):"Budget exceeded")}throw Error("failed_to_start: ".concat(e))}let r=await l.json();D(r.id),"number"==typeof r.estimatedUsd&&W(Number.isFinite(r.estimatedUsd)?Number(r.estimatedUsd):H);let d=new EventSource("/api/scale/".concat(r.id,"/status"));null===(a=I.current)||void 0===a||a.close(),I.current=d,d.onmessage=e=>{if("[DONE]"===e.data){d.close(),I.current=null,T(!1);let e=r.id;(async()=>{try{let s=await fetch("/api/scale/".concat(e,"/report"),{cache:"no-store"});if(s.ok){var t,a;let e=await s.json();J({summary:e.summary,revisedPrompt:e.revisedPrompt,rationale:null!==(a=null===(t=e.stats)||void 0===t?void 0:t.rationale)&&void 0!==a?a:void 0,stats:e.stats})}}catch(e){}})();return}try{let t=JSON.parse(e.data);t&&O(t)}catch(e){}},d.onerror=()=>{_("stream_error"),d.close(),I.current=null,T(!1)};{let e=r.id;setTimeout(async()=>{try{let s=await fetch("/api/scale/".concat(e,"/report"),{cache:"no-store"});if(s.ok){var t,a;let e=await s.json();J({summary:e.summary,revisedPrompt:e.revisedPrompt,rationale:null!==(a=null===(t=e.stats)||void 0===t?void 0:t.rationale)&&void 0!==a?a:void 0,stats:e.stats})}}catch(e){}},150)}}catch(e){_(String(e.message||e)),T(!1)}}}(0,l.useEffect)(()=>{{let e=Date.now();D("e2e-run"),O({id:"e2e-run",type:"scale",status:"succeeded",createdAt:e,updatedAt:e,data:{total:2,succeeded:2,failed:0}}),J({summary:"E2E summary",revisedPrompt:"E2E revised prompt",rationale:"E2E rationale",stats:{total:2,succeeded:2,failed:0,actualUsd:0}}),T(!1)}},[]),(0,l.useEffect)(()=>{(async()=>{try{await n(y.provider,y.model||"");let e=150*F,t=300*F,{usdIn:a,usdOut:s}=function(e,t,a){var s,l,n,o;let c=null!==(l=null==a?void 0:a.inputTokens)&&void 0!==l?l:0,u=null!==(n=null==a?void 0:a.outputTokens)&&void 0!==n?n:0,m=null!==(o=null===(s=r[i(e,t)])||void 0===s?void 0:s.price)&&void 0!==o?o:d[e];return{usdIn:c/1e3*m.inputPer1k,usdOut:u/1e3*m.outputPer1k}}(y.provider,y.model||"",{inputTokens:e,outputTokens:t});W(parseFloat((a+s).toFixed(4)))}catch(e){W(0)}})()},[y.provider,y.model,F]),(0,l.useEffect)(()=>{let e=e=>{R&&(e.preventDefault(),e.returnValue="")};return window.addEventListener("beforeunload",e),()=>{var t,a;null===(t=I.current)||void 0===t||t.close(),I.current=null,null===(a=$.current)||void 0===a||a.abort(),window.removeEventListener("beforeunload",e)}},[R]);let Q=!!(M&&("succeeded"===M.status||"failed"===M.status)),X=null!==(p=null==M?void 0:M.data)&&void 0!==p?p:null,[Y,Z]=(0,l.useState)({}),[ee,et]=(0,l.useState)({});async function ea(e){let t=!Y[e];if(Z(a=>({...a,[e]:t})),t&&!ee[e])try{let t=await fetch("/api/battles/".concat(e,"/messages?page=1&limit=100"),{cache:"no-store"});if(!t.ok)return;let a=await t.json();et(t=>({...t,[e]:a.items}))}catch(e){}}function es(e){return"number"==typeof e&&Number.isFinite(e)?e:void 0}(0,l.useEffect)(()=>{Q&&A&&!B&&(async()=>{try{let a=await fetch("/api/scale/".concat(A,"/report"),{cache:"no-store"});if(a.ok){var e,t;let s=await a.json();J({summary:s.summary,revisedPrompt:s.revisedPrompt,rationale:null!==(t=null===(e=s.stats)||void 0===e?void 0:e.rationale)&&void 0!==t?t:void 0,stats:s.stats})}}catch(e){}})()},[Q,A,B]);let el=null==B?void 0:B.stats,er=null!==(x=es(null==el?void 0:el.total))&&void 0!==x?x:es(null==M?void 0:null===(a=M.data)||void 0===a?void 0:a.total),ed=null!==(v=es(null==el?void 0:el.succeeded))&&void 0!==v?v:es(null==M?void 0:null===(c=M.data)||void 0===c?void 0:c.succeeded),ei=null!==(h=es(null==el?void 0:el.failed))&&void 0!==h?h:es(null==M?void 0:null===(u=M.data)||void 0===u?void 0:u.failed),en=es(null==el?void 0:el.actualUsd);return(0,s.jsxs)("form",{onSubmit:K,className:"space-y-4",children:[(0,s.jsxs)("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2",children:[(0,s.jsxs)("label",{className:"block text-sm text-slate-200",children:["Agent",(0,s.jsx)("select",{value:j,onChange:e=>N(e.target.value),className:"mt-1 w-full rounded border border-slate-600 bg-slate-800 p-2 text-slate-100",children:g.map(e=>(0,s.jsx)("option",{value:e.id,children:e.name},e.id))})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)(o.U,{provider:y.provider,model:y.model,onChange:w}),(0,s.jsx)("input",{type:"hidden","data-testid":"model-input",value:y.model,readOnly:!0})]})]}),(0,s.jsxs)("label",{className:"block text-sm text-slate-200",children:["System prompt (optional)",(0,s.jsx)("textarea",{value:k,onChange:e=>E(e.target.value),className:"mt-1 w-full rounded border border-slate-600 bg-slate-800 p-2 text-slate-100",rows:3})]}),(0,s.jsxs)("label",{className:"block text-sm text-slate-200",children:["User message (optional)",(0,s.jsx)("textarea",{value:P,onChange:e=>S(e.target.value),className:"mt-1 w-full rounded border border-slate-600 bg-slate-800 p-2 text-slate-100",rows:2})]}),(0,s.jsxs)("label",{className:"block text-sm text-slate-200",children:["Runs (1–10)",(0,s.jsx)("input",{type:"number",min:1,max:10,value:F,onChange:e=>C(Number(e.target.value)),className:"mt-1 w-32 rounded border border-slate-600 bg-slate-800 p-2 text-slate-100"})]}),(0,s.jsxs)("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2",children:[(0,s.jsxs)("label",{className:"block text-sm text-slate-200",children:["Max budget USD (optional)",(0,s.jsx)("input",{type:"number",min:0,step:"0.01",value:L,onChange:e=>V(e.target.value),className:"mt-1 w-full rounded border border-slate-600 bg-slate-800 p-2 text-slate-100",placeholder:"e.g. 0.50"})]}),(0,s.jsxs)("div",{className:"rounded bg-slate-800 p-3",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between text-xs text-slate-300",children:[(0,s.jsx)("span",{children:"Estimated"}),(0,s.jsxs)("span",{children:["$",H.toFixed(4)]})]}),(0,s.jsx)("div",{className:"mt-1 h-2 w-full overflow-hidden rounded bg-slate-700",children:(0,s.jsx)("div",{className:"h-full bg-green-600",style:{width:"".concat(Math.min(100,Math.max(0,L&&parseFloat(L)>0?H/parseFloat(L)*100:0)),"%")},"aria-valuemin":0,"aria-valuemax":100,"aria-valuenow":L&&parseFloat(L)>0?Math.min(100,H/parseFloat(L)*100):0,role:"progressbar","aria-label":"Estimated budget usage"})}),L&&parseFloat(L)>0&&H>parseFloat(L)&&(0,s.jsx)("div",{className:"mt-1 text-xs text-yellow-300",children:"Estimated cost exceeds max budget"})]})]}),(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)("button",{type:"submit",disabled:!G,className:"rounded bg-blue-600 px-4 py-2 text-white disabled:cursor-not-allowed disabled:opacity-60",children:R?"Running…":"Start batch"}),(0,s.jsx)("span",{"aria-live":"polite",className:"text-sm text-slate-300",children:M?"Status: ".concat(M.status):R?"pending…":""})]}),U&&(0,s.jsx)("div",{role:"alert",className:"rounded border border-red-600 bg-red-950/40 p-2 text-sm text-red-300",children:U}),Q&&(null==M?void 0:M.status)==="succeeded"&&X||B?(0,s.jsxs)("div",{className:"mt-4 grid gap-4",children:[(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,s.jsxs)("div",{className:"rounded bg-slate-800 p-3",children:[(0,s.jsx)("div",{className:"text-slate-400",children:"Run ID"}),(0,s.jsx)("div",{className:"text-slate-100",children:A})]}),(0,s.jsxs)("div",{className:"rounded bg-slate-800 p-3",children:[(0,s.jsx)("div",{className:"text-slate-400",children:"Total"}),(0,s.jsx)("div",{className:"text-slate-100",children:X?X.total:0})]}),(0,s.jsxs)("div",{className:"rounded bg-slate-800 p-3",children:[(0,s.jsx)("div",{className:"text-slate-400",children:"Succeeded"}),(0,s.jsx)("div",{className:"text-slate-100",children:X?X.succeeded:0})]}),(0,s.jsxs)("div",{className:"rounded bg-slate-800 p-3",children:[(0,s.jsx)("div",{className:"text-slate-400",children:"Failed"}),(0,s.jsx)("div",{className:"text-slate-100",children:X?X.failed:0})]})]}),X&&Array.isArray(X.conversationIds)&&X.conversationIds.length>0&&(0,s.jsxs)("div",{className:"rounded bg-slate-800 p-3",children:[(0,s.jsx)("h3",{className:"mb-2 text-sm font-medium text-blue-300",children:"Conversations"}),(0,s.jsx)("ul",{className:"space-y-2",children:X.conversationIds.map(e=>(0,s.jsxs)("li",{className:"rounded bg-slate-900 p-2",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("code",{className:"text-xs text-slate-400",children:e}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("a",{href:"/api/battles/".concat(e,"/messages?page=1&limit=100"),target:"_blank",rel:"noreferrer",className:"rounded bg-slate-700 px-2 py-1 text-xs text-slate-200 hover:bg-slate-600",children:"View JSON"}),(0,s.jsx)("button",{type:"button",onClick:()=>ea(e),className:"rounded bg-slate-700 px-2 py-1 text-xs text-slate-200 hover:bg-slate-600","aria-expanded":!!Y[e],"aria-controls":"conv-".concat(e),children:Y[e]?"Hide":"Preview"})]})]}),Y[e]&&(0,s.jsx)("div",{id:"conv-".concat(e),className:"mt-2 rounded bg-slate-950 p-2",children:(0,s.jsx)("pre",{className:"whitespace-pre-wrap text-xs text-slate-200",children:(ee[e]||[]).map(e=>"[".concat(e.role,"] ").concat(e.content)).join("\n")||"Loading..."})})]},e))})]}),((null==B?void 0:B.stats)||(null==B?void 0:B.summary)||(null==B?void 0:B.revisedPrompt))&&(0,s.jsxs)("div",{className:"rounded bg-slate-800 p-3",children:[(0,s.jsx)("h3",{className:"mb-2 text-sm font-medium text-blue-300",children:"Run Report"}),(void 0!==ed||void 0!==ei)&&(0,s.jsxs)("div",{className:"mb-3 flex flex-wrap items-center gap-2",children:[void 0!==ed&&(0,s.jsxs)("span",{className:"rounded bg-green-900/40 px-2 py-0.5 text-xs text-green-300",children:["Succeeded: ",ed]}),void 0!==ei&&(0,s.jsxs)("span",{className:"rounded bg-red-900/40 px-2 py-0.5 text-xs text-red-300",children:["Failed: ",ei]}),"number"==typeof er&&er>0&&"number"==typeof ed?(0,s.jsxs)("span",{className:"rounded bg-slate-700 px-2 py-0.5 text-xs text-slate-200",children:["Win rate: ",Math.round(ed/er*100),"%"]}):null]}),(0,s.jsxs)("div",{className:"mb-3 grid grid-cols-2 gap-3",children:[(0,s.jsxs)("div",{className:"rounded bg-slate-900 p-2",children:[(0,s.jsx)("div",{className:"text-[11px] text-slate-400",children:"Estimated"}),(0,s.jsxs)("div",{className:"text-sm text-slate-100",children:["$",H.toFixed(4)]})]}),(0,s.jsxs)("div",{className:"rounded bg-slate-900 p-2",children:[(0,s.jsx)("div",{className:"text-[11px] text-slate-400",children:"Actual"}),(0,s.jsxs)("div",{className:"text-sm text-slate-100",children:["$",(null!=en?en:q).toFixed(4)]})]})]}),B.summary&&(0,s.jsx)("p",{className:"whitespace-pre-wrap text-sm text-slate-200",children:B.summary}),B.revisedPrompt&&(0,s.jsxs)("div",{className:"mt-3",children:[(0,s.jsx)("div",{className:"mb-1 text-sm text-slate-300",children:"Revised Prompt"}),(0,s.jsx)("pre",{className:"whitespace-pre-wrap rounded bg-slate-950 p-2 text-xs text-slate-100",children:B.revisedPrompt}),(0,s.jsxs)("div",{className:"mt-2 flex gap-2",children:[(0,s.jsx)("button",{type:"button",onClick:async()=>{try{await navigator.clipboard.writeText(B.revisedPrompt||"")}catch(e){}},className:"rounded bg-slate-700 px-2 py-1 text-xs text-slate-200 hover:bg-slate-600",children:"Copy prompt"}),B.rationale&&(0,s.jsx)("button",{type:"button",onClick:async()=>{try{await navigator.clipboard.writeText(B.rationale||"")}catch(e){}},className:"rounded bg-slate-700 px-2 py-1 text-xs text-slate-200 hover:bg-slate-600",children:"Copy rationale"})]})]})]})]}):null,Q&&(null==M?void 0:M.status)==="failed"&&(0,s.jsxs)("div",{role:"alert",className:"rounded border border-red-600 bg-red-950/40 p-3 text-red-300",children:["Batch failed: ",(null==M?void 0:M.error)||"unknown error"]})]})}}},function(e){e.O(0,[971,23,744],function(){return e(e.s=2628)}),_N_E=e.O()}]);