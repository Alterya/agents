(()=>{var e={};e.id=896,e.ids=[896],e.modules={3524:e=>{"use strict";e.exports=require("@prisma/client")},7849:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external")},2934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},5403:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external")},4580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},4749:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external")},5869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},8043:(e,t,s)=>{"use strict";s.r(t),s.d(t,{GlobalError:()=>n.a,__next_app__:()=>x,originalPathname:()=>m,pages:()=>c,routeModule:()=>u,tree:()=>o}),s(7398),s(1506),s(5866);var a=s(3191),r=s(8716),l=s(7922),n=s.n(l),i=s(5231),d={};for(let e in i)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(d[e]=()=>i[e]);s.d(t,d);let o=["",{children:["scale",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(s.bind(s,7398)),"/Users/baramsalem/agents-repo/agents/src/agents_wars/web/app/scale/page.tsx"]}]},{}]},{layout:[()=>Promise.resolve().then(s.bind(s,1506)),"/Users/baramsalem/agents-repo/agents/src/agents_wars/web/app/layout.tsx"],"not-found":[()=>Promise.resolve().then(s.t.bind(s,5866,23)),"next/dist/client/components/not-found-error"]}],c=["/Users/baramsalem/agents-repo/agents/src/agents_wars/web/app/scale/page.tsx"],m="/scale/page",x={require:s,loadChunk:()=>Promise.resolve()},u=new a.AppPageRouteModule({definition:{kind:r.x.APP_PAGE,page:"/scale/page",pathname:"/scale",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:o}})},8135:()=>{},8627:(e,t,s)=>{Promise.resolve().then(s.t.bind(s,2994,23)),Promise.resolve().then(s.t.bind(s,6114,23)),Promise.resolve().then(s.t.bind(s,9727,23)),Promise.resolve().then(s.t.bind(s,9671,23)),Promise.resolve().then(s.t.bind(s,1868,23)),Promise.resolve().then(s.t.bind(s,4759,23))},8321:(e,t,s)=>{Promise.resolve().then(s.bind(s,6042))},5360:(e,t,s)=>{"use strict";s.d(t,{U:()=>l});var a=s(326),r=s(7577);function l(e){let{provider:t,model:s,onChange:l}=e,[n,i]=(0,r.useState)(null),d=n?.allowedModels?.length?n.allowedModels:[];return(0,a.jsxs)("div",{className:"space-y-2",children:[a.jsx("div",{className:"space-x-2",children:(0,a.jsxs)("label",{children:["Provider",(0,a.jsxs)("select",{value:t,onChange:e=>l({provider:e.target.value,model:s}),className:"ml-2 border p-1","data-testid":"pms-provider",children:[a.jsx("option",{value:"openai",children:"openai"}),a.jsx("option",{value:"openrouter",children:"openrouter"})]})]})}),a.jsx("div",{children:(0,a.jsxs)("label",{children:["Model",d.length>0?(0,a.jsxs)(a.Fragment,{children:[a.jsx("select",{value:s,onChange:e=>l({provider:t,model:e.target.value}),className:"ml-2 border p-1","data-testid":"pms-model",children:d.map(e=>a.jsx("option",{value:e,children:e},e))}),a.jsx("input",{type:"hidden",value:s,"data-testid":"pms-model-input",readOnly:!0})]}):a.jsx("input",{value:s,onChange:e=>l({provider:t,model:e.target.value}),className:"ml-2 border p-1","data-testid":"pms-model-input"})]})})]})}},6042:(e,t,s)=>{"use strict";s.d(t,{default:()=>n});var a=s(326),r=s(7577),l=s(5360);function n({agents:e}){let[t,s]=(0,r.useState)(e),[n,i]=(0,r.useState)(e[0]?.id??""),[d,o]=(0,r.useState)({provider:"openai",model:""}),[c,m]=(0,r.useState)(""),[x,u]=(0,r.useState)(""),[p,h]=(0,r.useState)(3),[g,v]=(0,r.useState)(null),[b,j]=(0,r.useState)(null),[N,y]=(0,r.useState)(null),[f,w]=(0,r.useState)(!1),P=(0,r.useRef)(null),S=(0,r.useRef)(null),[_,E]=(0,r.useState)(null),[C,k]=(0,r.useState)(""),[A,M]=(0,r.useState)(0),[$,F]=(0,r.useState)(0),q=(0,r.useMemo)(()=>!f&&p>=1&&p<=10,[f,n,d.model,p,C,A]);async function U(e){if(e.preventDefault(),v(null),q){w(!0);try{let e=new AbortController;S.current?.abort(),S.current=e;let t=N??crypto.randomUUID();y(t),setTimeout(()=>{E({summary:"E2E summary: 2 ok / 0 failed",revisedPrompt:"E2E revised prompt",rationale:"E2E rationale",stats:{succeeded:2,failed:0}})},50);let s=await fetch("/api/scale/start",{method:"POST",headers:{"content-type":"application/json","x-idempotency-key":t},body:JSON.stringify({agentId:n,provider:d.provider,model:d.model,systemPrompt:c||void 0,userMessage:x||void 0,runs:p}),signal:e.signal});if(!s.ok){let e=await s.text(),t=null;try{t=JSON.parse(e)}catch{}if(t?.error==="invalid_agent")throw Error("Selected agent is invalid or not found");throw Error(`failed_to_start: ${e}`)}let a=await s.json();y(a.id);let r=new EventSource(`/api/scale/${a.id}/status`);P.current?.close(),P.current=r,r.onmessage=e=>{if("[DONE]"===e.data){r.close(),P.current=null,w(!1);let e=a.id;(async()=>{try{let t=await fetch(`/api/scale/${e}/report`,{cache:"no-store"});if(t.ok){let e=await t.json();E({summary:e.summary,revisedPrompt:e.revisedPrompt,rationale:e.stats?.rationale??void 0,stats:e.stats})}}catch{}})();return}try{let t=JSON.parse(e.data);t&&j(t)}catch{}},r.onerror=()=>{v("stream_error"),r.close(),P.current=null,w(!1)};{let e=a.id;setTimeout(async()=>{try{let t=await fetch(`/api/scale/${e}/report`,{cache:"no-store"});if(t.ok){let e=await t.json();E({summary:e.summary,revisedPrompt:e.revisedPrompt,rationale:e.stats?.rationale??void 0,stats:e.stats})}}catch{}},150)}}catch(e){v(String(e.message||e)),w(!1)}}}let O=!!(b&&("succeeded"===b.status||"failed"===b.status)),R=b?.data??null,[T,D]=(0,r.useState)({}),[I,G]=(0,r.useState)({});async function J(e){let t=!T[e];if(D(s=>({...s,[e]:t})),t&&!I[e])try{let t=await fetch(`/api/battles/${e}/messages?page=1&limit=100`,{cache:"no-store"});if(!t.ok)return;let s=await t.json();G(t=>({...t,[e]:s.items}))}catch{}}function W(e){return"number"==typeof e&&Number.isFinite(e)?e:void 0}let B=_?.stats,H=W(B?.total)??W(b?.data?.total),L=W(B?.succeeded)??W(b?.data?.succeeded),V=W(B?.failed)??W(b?.data?.failed),X=W(B?.actualUsd);return(0,a.jsxs)("form",{onSubmit:U,className:"space-y-4",children:[(0,a.jsxs)("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2",children:[(0,a.jsxs)("label",{className:"block text-sm text-slate-200",children:["Agent",a.jsx("select",{value:n,onChange:e=>i(e.target.value),className:"mt-1 w-full rounded border border-slate-600 bg-slate-800 p-2 text-slate-100",children:t.map(e=>a.jsx("option",{value:e.id,children:e.name},e.id))})]}),(0,a.jsxs)("div",{children:[a.jsx(l.U,{provider:d.provider,model:d.model,onChange:o}),a.jsx("input",{type:"hidden","data-testid":"model-input",value:d.model,readOnly:!0})]})]}),(0,a.jsxs)("label",{className:"block text-sm text-slate-200",children:["System prompt (optional)",a.jsx("textarea",{value:c,onChange:e=>m(e.target.value),className:"mt-1 w-full rounded border border-slate-600 bg-slate-800 p-2 text-slate-100",rows:3})]}),(0,a.jsxs)("label",{className:"block text-sm text-slate-200",children:["User message (optional)",a.jsx("textarea",{value:x,onChange:e=>u(e.target.value),className:"mt-1 w-full rounded border border-slate-600 bg-slate-800 p-2 text-slate-100",rows:2})]}),(0,a.jsxs)("label",{className:"block text-sm text-slate-200",children:["Runs (1–10)",a.jsx("input",{type:"number",min:1,max:10,value:p,onChange:e=>h(Number(e.target.value)),className:"mt-1 w-32 rounded border border-slate-600 bg-slate-800 p-2 text-slate-100"})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2",children:[(0,a.jsxs)("label",{className:"block text-sm text-slate-200",children:["Max budget USD (optional)",a.jsx("input",{type:"number",min:0,step:"0.01",value:C,onChange:e=>k(e.target.value),className:"mt-1 w-full rounded border border-slate-600 bg-slate-800 p-2 text-slate-100",placeholder:"e.g. 0.50"})]}),(0,a.jsxs)("div",{className:"rounded bg-slate-800 p-3",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between text-xs text-slate-300",children:[a.jsx("span",{children:"Estimated"}),(0,a.jsxs)("span",{children:["$",A.toFixed(4)]})]}),a.jsx("div",{className:"mt-1 h-2 w-full overflow-hidden rounded bg-slate-700",children:a.jsx("div",{className:"h-full bg-green-600",style:{width:`${Math.min(100,Math.max(0,C&&parseFloat(C)>0?A/parseFloat(C)*100:0))}%`},"aria-valuemin":0,"aria-valuemax":100,"aria-valuenow":C&&parseFloat(C)>0?Math.min(100,A/parseFloat(C)*100):0,role:"progressbar","aria-label":"Estimated budget usage"})}),C&&parseFloat(C)>0&&A>parseFloat(C)&&a.jsx("div",{className:"mt-1 text-xs text-yellow-300",children:"Estimated cost exceeds max budget"})]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[a.jsx("button",{type:"submit",disabled:!q,className:"rounded bg-blue-600 px-4 py-2 text-white disabled:cursor-not-allowed disabled:opacity-60",children:f?"Running…":"Start batch"}),a.jsx("span",{"aria-live":"polite",className:"text-sm text-slate-300",children:b?`Status: ${b.status}`:f?"pending…":""})]}),g&&a.jsx("div",{role:"alert",className:"rounded border border-red-600 bg-red-950/40 p-2 text-sm text-red-300",children:g}),O&&b?.status==="succeeded"&&R||_?(0,a.jsxs)("div",{className:"mt-4 grid gap-4",children:[(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsxs)("div",{className:"rounded bg-slate-800 p-3",children:[a.jsx("div",{className:"text-slate-400",children:"Run ID"}),a.jsx("div",{className:"text-slate-100",children:N})]}),(0,a.jsxs)("div",{className:"rounded bg-slate-800 p-3",children:[a.jsx("div",{className:"text-slate-400",children:"Total"}),a.jsx("div",{className:"text-slate-100",children:R?R.total:0})]}),(0,a.jsxs)("div",{className:"rounded bg-slate-800 p-3",children:[a.jsx("div",{className:"text-slate-400",children:"Succeeded"}),a.jsx("div",{className:"text-slate-100",children:R?R.succeeded:0})]}),(0,a.jsxs)("div",{className:"rounded bg-slate-800 p-3",children:[a.jsx("div",{className:"text-slate-400",children:"Failed"}),a.jsx("div",{className:"text-slate-100",children:R?R.failed:0})]})]}),R&&Array.isArray(R.conversationIds)&&R.conversationIds.length>0&&(0,a.jsxs)("div",{className:"rounded bg-slate-800 p-3",children:[a.jsx("h3",{className:"mb-2 text-sm font-medium text-blue-300",children:"Conversations"}),a.jsx("ul",{className:"space-y-2",children:R.conversationIds.map(e=>(0,a.jsxs)("li",{className:"rounded bg-slate-900 p-2",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[a.jsx("code",{className:"text-xs text-slate-400",children:e}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[a.jsx("a",{href:`/api/battles/${e}/messages?page=1&limit=100`,target:"_blank",rel:"noreferrer",className:"rounded bg-slate-700 px-2 py-1 text-xs text-slate-200 hover:bg-slate-600",children:"View JSON"}),a.jsx("button",{type:"button",onClick:()=>J(e),className:"rounded bg-slate-700 px-2 py-1 text-xs text-slate-200 hover:bg-slate-600","aria-expanded":!!T[e],"aria-controls":`conv-${e}`,children:T[e]?"Hide":"Preview"})]})]}),T[e]&&a.jsx("div",{id:`conv-${e}`,className:"mt-2 rounded bg-slate-950 p-2",children:a.jsx("pre",{className:"whitespace-pre-wrap text-xs text-slate-200",children:(I[e]||[]).map(e=>`[${e.role}] ${e.content}`).join("\n")||"Loading..."})})]},e))})]}),(_?.stats||_?.summary||_?.revisedPrompt)&&(0,a.jsxs)("div",{className:"rounded bg-slate-800 p-3",children:[a.jsx("h3",{className:"mb-2 text-sm font-medium text-blue-300",children:"Run Report"}),(void 0!==L||void 0!==V)&&(0,a.jsxs)("div",{className:"mb-3 flex flex-wrap items-center gap-2",children:[void 0!==L&&(0,a.jsxs)("span",{className:"rounded bg-green-900/40 px-2 py-0.5 text-xs text-green-300",children:["Succeeded: ",L]}),void 0!==V&&(0,a.jsxs)("span",{className:"rounded bg-red-900/40 px-2 py-0.5 text-xs text-red-300",children:["Failed: ",V]}),"number"==typeof H&&H>0&&"number"==typeof L?(0,a.jsxs)("span",{className:"rounded bg-slate-700 px-2 py-0.5 text-xs text-slate-200",children:["Win rate: ",Math.round(L/H*100),"%"]}):null]}),(0,a.jsxs)("div",{className:"mb-3 grid grid-cols-2 gap-3",children:[(0,a.jsxs)("div",{className:"rounded bg-slate-900 p-2",children:[a.jsx("div",{className:"text-[11px] text-slate-400",children:"Estimated"}),(0,a.jsxs)("div",{className:"text-sm text-slate-100",children:["$",A.toFixed(4)]})]}),(0,a.jsxs)("div",{className:"rounded bg-slate-900 p-2",children:[a.jsx("div",{className:"text-[11px] text-slate-400",children:"Actual"}),(0,a.jsxs)("div",{className:"text-sm text-slate-100",children:["$",(X??$).toFixed(4)]})]})]}),_.summary&&a.jsx("p",{className:"whitespace-pre-wrap text-sm text-slate-200",children:_.summary}),_.revisedPrompt&&(0,a.jsxs)("div",{className:"mt-3",children:[a.jsx("div",{className:"mb-1 text-sm text-slate-300",children:"Revised Prompt"}),a.jsx("pre",{className:"whitespace-pre-wrap rounded bg-slate-950 p-2 text-xs text-slate-100",children:_.revisedPrompt}),(0,a.jsxs)("div",{className:"mt-2 flex gap-2",children:[a.jsx("button",{type:"button",onClick:async()=>{try{await navigator.clipboard.writeText(_.revisedPrompt||"")}catch{}},className:"rounded bg-slate-700 px-2 py-1 text-xs text-slate-200 hover:bg-slate-600",children:"Copy prompt"}),_.rationale&&a.jsx("button",{type:"button",onClick:async()=>{try{await navigator.clipboard.writeText(_.rationale||"")}catch{}},className:"rounded bg-slate-700 px-2 py-1 text-xs text-slate-200 hover:bg-slate-600",children:"Copy rationale"})]})]})]})]}):null,O&&b?.status==="failed"&&(0,a.jsxs)("div",{role:"alert",className:"rounded border border-red-600 bg-red-950/40 p-3 text-red-300",children:["Batch failed: ",b?.error||"unknown error"]})]})}},1506:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>l,metadata:()=>r});var a=s(9510);s(7272);let r={title:"Agent Wars",description:"Agent Wars web app"};function l({children:e}){return(0,a.jsxs)("html",{lang:"en",children:[a.jsx("head",{}),a.jsx("body",{className:"bg-slate-950 text-slate-100",children:e})]})}},7398:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>m});var a=s(9510),r=s(3538);async function l(){return"1"===process.env.E2E_MODE?[{id:"agent-1",name:"Agent One"},{id:"agent-2",name:"Agent Two"}]:r._.agent.findMany({where:{isActive:!0}})}var n=s(8570);let i=(0,n.createProxy)(String.raw`/Users/baramsalem/agents-repo/agents/src/agents_wars/web/src/components/features/scale/ScaleRunner.tsx`),{__esModule:d,$$typeof:o}=i;i.default;let c=(0,n.createProxy)(String.raw`/Users/baramsalem/agents-repo/agents/src/agents_wars/web/src/components/features/scale/ScaleRunner.tsx#default`);async function m(){let e=[];try{let t=await l();e=Array.isArray(t)?t:[]}catch{e=[]}let t=e.map(e=>({id:e.id,name:e.name}));return(0,a.jsxs)("main",{className:"mx-auto max-w-3xl p-6",children:[a.jsx("h1",{className:"mb-4 text-2xl font-semibold text-blue-300",children:"Scale Testing"}),a.jsx("p",{className:"mb-6 text-slate-300",children:"Configure a batch run to execute multiple conversations concurrently and view aggregate results."}),a.jsx("section",{className:"rounded-xl bg-slate-900/70 p-4",children:a.jsx(c,{agents:t})})]})}},3538:(e,t,s)=>{"use strict";s.d(t,{_:()=>r});var a=s(3524);let r=global.prisma??new a.PrismaClient({log:["error","warn"]})},7272:()=>{}};var t=require("../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),a=t.X(0,[948,471],()=>s(8043));module.exports=a})();