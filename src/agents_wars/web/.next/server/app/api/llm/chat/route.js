"use strict";(()=>{var e={};e.id=217,e.ids=[217],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7147:e=>{e.exports=require("fs")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},7561:e=>{e.exports=require("node:fs")},4492:e=>{e.exports=require("node:stream")},2477:e=>{e.exports=require("node:stream/web")},1017:e=>{e.exports=require("path")},5477:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},7310:e=>{e.exports=require("url")},3837:e=>{e.exports=require("util")},1267:e=>{e.exports=require("worker_threads")},9796:e=>{e.exports=require("zlib")},7446:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>g,requestAsyncStorage:()=>_,routeModule:()=>m,serverHooks:()=>f,staticGenerationAsyncStorage:()=>E});var o={};r.r(o),r.d(o,{POST:()=>c});var n=r(9303),a=r(8716),s=r(670),i=r(7410),u=r(3280),l=r(8907);let p=i.z.object({provider:i.z.enum(["openai","openrouter"]),model:i.z.string().min(1),messages:i.z.array(i.z.object({role:i.z.enum(["system","user","assistant","tool"]),content:i.z.string()})),maxTokens:i.z.number().int().positive().optional(),temperature:i.z.number().min(0).max(2).optional(),stream:i.z.boolean().optional()});async function c(e){try{let t=await e.json(),r=p.safeParse(t);if(!r.success)return new Response(JSON.stringify({error:"invalid_body",details:r.error.flatten()}),{status:400,headers:{"content-type":"application/json"}});let{provider:o,model:n,messages:a,maxTokens:s,temperature:i,stream:c}=r.data,m=e.headers.get("x-forwarded-for")?.split(",")[0]?.trim()||"local";try{(0,l.hb)(`ip:${m}`)}catch(e){if(e instanceof l.Mh)return new Response(JSON.stringify({error:"rate_limited"}),{status:429,headers:{"content-type":"application/json"}});throw e}if("promptbro"===e.headers.get("x-assist")){let e=process.env.PROMPTBRO_ASSIST_DAILY_CAP,t=Math.max(1,Number(e??50)),r=new Date().toISOString().slice(0,10);globalThis.__pb_daily=globalThis.__pb_daily||new Map;let o=`${m}:${r}`,n=globalThis.__pb_daily.get(o)??0;if(n>=t)return new Response(JSON.stringify({error:"daily_cap_reached"}),{status:429,headers:{"content-type":"application/json"}});globalThis.__pb_daily.set(o,n+1)}if(c)try{let e=await (0,u.W)(a,{provider:o,model:n,maxTokens:Math.min("number"==typeof s?s:128,128),temperature:i,stream:!0}),t=new TextEncoder,r=e.raw,l=new ReadableStream({async start(o){try{if(r&&Symbol.asyncIterator in r){for await(let e of r){let r=e?.choices?.[0]?.delta?.content;r&&o.enqueue(t.encode(`data: ${JSON.stringify({delta:r})}

`))}o.enqueue(t.encode(`data: [DONE]

`))}else o.enqueue(t.encode(`data: ${JSON.stringify({text:e.text})}

`)),o.enqueue(t.encode(`data: [DONE]

`));o.close()}catch{o.enqueue(t.encode(`event: error
`)),o.enqueue(t.encode(`data: ${JSON.stringify({error:"stream_failed"})}

`)),o.close()}}});return new Response(l,{status:200,headers:{"content-type":"text/event-stream; charset=utf-8","cache-control":"no-cache, no-transform",connection:"keep-alive"}})}catch(t){let e=d(t);return new Response(JSON.stringify({error:"chat_failed"}),{status:e,headers:{"content-type":"application/json"}})}let _=await (0,u.W)(a,{provider:o,model:n,maxTokens:Math.min("number"==typeof s?s:128,128),temperature:i});return new Response(JSON.stringify({text:_.text,usage:_.usage}),{status:200,headers:{"content-type":"application/json"}})}catch(t){let e=d(t);return new Response(JSON.stringify({error:"internal_error"}),{status:e,headers:{"content-type":"application/json"}})}}function d(e){if(e instanceof l.Mh)return String(e.message).toLowerCase().includes("rate limit")?429:400;let t=e?.status??e?.response?.status;return 429===t?429:"number"==typeof t&&t>=500&&t<=599?502:500}let m=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/llm/chat/route",pathname:"/api/llm/chat",filename:"route",bundlePath:"app/api/llm/chat/route"},resolvedPagePath:"/Users/baramsalem/agents-repo/agents/src/agents_wars/web/app/api/llm/chat/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:_,staticGenerationAsyncStorage:E,serverHooks:f}=m,h="/api/llm/chat/route";function g(){return(0,s.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:E})}},5844:(e,t,r)=>{let o;r.d(t,{i:()=>i});var n=r(7410);let a=e=>n.z.preprocess(e=>"string"==typeof e&&0===e.trim().length?void 0:e,e.optional()),s=n.z.object({OPENAI_API_KEY:a(n.z.string().trim().min(1)),OPENROUTER_API_KEY:a(n.z.string().trim().min(1)),OPENROUTER_SITE:a(n.z.string().trim()),ALLOWED_MODELS:a(n.z.string().trim()),SUMMARIZER_MODEL:a(n.z.string().trim()),MAX_TOKENS_PER_CALL:n.z.coerce.number().int().positive().default(512),MAX_MESSAGES_PER_CONVO:n.z.coerce.number().int().positive().default(25),RATE_LIMIT_ENABLED:n.z.union([n.z.string(),n.z.boolean()]).transform(e=>"string"==typeof e?"false"!==e.toLowerCase():!!e).default(!0),RATE_LIMIT_RPM:n.z.coerce.number().int().positive().default(60),REQUEST_TIMEOUT_MS:n.z.coerce.number().int().positive().default(6e4),MAX_USD_PER_CONVO:n.z.coerce.number().nonnegative().optional()}).refine(e=>!!(e.OPENAI_API_KEY||e.OPENROUTER_API_KEY),"At least one provider key must be set: OPENAI_API_KEY or OPENROUTER_API_KEY");function i(){if(o)return o;let e={...process.env},t=s.parse(e);return o={openaiApiKey:t.OPENAI_API_KEY||void 0,openrouterApiKey:t.OPENROUTER_API_KEY||void 0,openrouterSite:t.OPENROUTER_SITE||void 0,allowedModels:t.ALLOWED_MODELS?t.ALLOWED_MODELS.split(",").map(e=>e.trim()).filter(Boolean):[],summarizerModel:t.SUMMARIZER_MODEL||void 0,maxTokensPerCall:t.MAX_TOKENS_PER_CALL,maxMessagesPerConversation:t.MAX_MESSAGES_PER_CONVO,rateLimitEnabled:t.RATE_LIMIT_ENABLED,rateLimitRpm:t.RATE_LIMIT_RPM,requestTimeoutMs:t.REQUEST_TIMEOUT_MS,maxUsdPerConversation:t.MAX_USD_PER_CONVO,redisUrl:e.REDIS_URL||void 0}}},8907:(e,t,r)=>{r.d(t,{Mh:()=>n,Ow:()=>l,Sv:()=>a,_v:()=>u,hb:()=>i});var o=r(5844);class n extends Error{constructor(e){super(e),this.name="GuardrailsError"}}function a(e){let t=(0,o.i)().maxTokensPerCall;if((e.requestedMaxTokens??t)>t)throw new n(`maxTokens exceeds cap (${e.requestedMaxTokens} > ${t})`);let r=(0,o.i)().maxMessagesPerConversation;if(e.messageCount>r)throw new n(`message count exceeds cap (${e.messageCount} > ${r})`);let a=new Set((0,o.i)().allowedModels);if(a.size>0&&!a.has(e.model))throw new n(`model not allowed: ${e.model}`)}let s=new Map;function i(e){let t=(0,o.i)();if(!t.rateLimitEnabled)return;let r=t.rateLimitRpm,a=Date.now(),i=s.get(e);if(!i||a-i.windowStartMs>=6e4){s.set(e,{count:1,windowStartMs:a});return}if(i.count>=r)throw new n("rate limit exceeded");i.count+=1}async function u(e){await new Promise(t=>setTimeout(t,e))}function l(e){return 250+500*e+Math.floor(100*Math.random())}},3280:(e,t,r)=>{r.d(t,{W:()=>s});var o=r(4214),n=r(8907),a=r(5844);async function s(e,t){let r;if("1"===process.env.E2E_MODE){let t=[...e].reverse().find(e=>"user"===e.role);return{text:t?.content?`E2E: ${t.content}`:"E2E: ok",usage:{inputTokens:10,outputTokens:20},raw:{}}}(0,n.Sv)({requestedMaxTokens:t.maxTokens,messageCount:e.length,model:t.model}),(0,n.hb)(`${t.provider}:${t.model}`);let s=(0,a.i)(),i="openrouter"===t.provider,u=new o.ZP({apiKey:i?s.openrouterApiKey:s.openaiApiKey,baseURL:i?"https://openrouter.ai/api/v1":void 0}),l=i?{"HTTP-Referer":s.openrouterSite||"","X-Title":"Agent Wars"}:void 0;if(t.stream){let r=await u.chat.completions.create({model:t.model,messages:e,max_tokens:t.maxTokens??512,temperature:t.temperature??.2,stop:t.stop,stream:!0,extra_headers:l}),o="";for await(let e of r){let t=e?.choices?.[0]?.delta?.content;t&&(o+=t)}return{text:o,raw:r}}for(let o=0;o<3;o++)try{let r=await u.chat.completions.create({model:t.model,messages:e,max_tokens:t.maxTokens??512,temperature:t.temperature??.2,stop:t.stop,extra_headers:l}),o=r.choices?.[0]?.message?.content??"",n=r.usage?{inputTokens:r.usage.prompt_tokens??0,outputTokens:r.usage.completion_tokens??0}:void 0;return{text:o,usage:n,raw:r}}catch(t){r=t;let e=t?.status??t?.response?.status;if(o<2&&(429===e||e>=500&&e<=599)){await (0,n._v)((0,n.Ow)(o));continue}throw t}throw r}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[948,691,214],()=>r(7446));module.exports=o})();