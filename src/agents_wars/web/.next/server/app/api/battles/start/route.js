"use strict";(()=>{var e={};e.id=294,e.ids=[294],e.modules={3524:e=>{e.exports=require("@prisma/client")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9491:e=>{e.exports=require("assert")},4300:e=>{e.exports=require("buffer")},2081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},9523:e=>{e.exports=require("dns")},2361:e=>{e.exports=require("events")},7147:e=>{e.exports=require("fs")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},8188:e=>{e.exports=require("module")},1808:e=>{e.exports=require("net")},7561:e=>{e.exports=require("node:fs")},4492:e=>{e.exports=require("node:stream")},2477:e=>{e.exports=require("node:stream/web")},2037:e=>{e.exports=require("os")},1017:e=>{e.exports=require("path")},5477:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},1576:e=>{e.exports=require("string_decoder")},4404:e=>{e.exports=require("tls")},6224:e=>{e.exports=require("tty")},7310:e=>{e.exports=require("url")},3837:e=>{e.exports=require("util")},1267:e=>{e.exports=require("worker_threads")},9796:e=>{e.exports=require("zlib")},8252:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>w,requestAsyncStorage:()=>y,routeModule:()=>q,serverHooks:()=>b,staticGenerationAsyncStorage:()=>h});var s={};r.r(s),r.d(s,{POST:()=>x,runtime:()=>c});var i=r(9303),o=r(8716),a=r(670),n=r(7410),p=r(7546),u=r(7349),l=r(5884),d=r(8907),m=r(3538);let c="nodejs",g=n.z.object({id:n.z.string().trim().optional(),agentId:n.z.string().trim().min(1),provider:n.z.enum(["openai","openrouter"]),model:n.z.string().trim().min(1),systemPrompt:n.z.string().trim().optional(),goal:n.z.string().trim().optional(),messageLimit:n.z.coerce.number().int().positive().optional(),userMessage:n.z.string().trim().optional(),maxTokens:n.z.coerce.number().int().positive().optional(),temperature:n.z.coerce.number().min(0).max(2).optional()});async function x(e){try{let t=e.headers.get("x-request-id")||(globalThis.crypto?.randomUUID?.()??Math.random().toString(36).slice(2)),r=e.headers.get("x-forwarded-for")||"",s=r.split(",")[0]?.trim(),i=e?.ip||s||"local";try{(0,d.hb)(`start-battle:${i}`)}catch(e){return new Response(JSON.stringify({error:"rate_limited",details:String(e?.message||e)}),{status:429,headers:{"content-type":"application/json","x-request-id":t}})}let o=await e.json(),a=g.safeParse(o);if(!a.success)return new Response(JSON.stringify({error:"invalid_body",details:a.error.flatten()}),{status:400,headers:{"content-type":"application/json"}});let n=a.data;try{if(!await m._.agent.findUnique({where:{id:n.agentId}}))return new Response(JSON.stringify({error:"invalid_agent"}),{status:400,headers:{"content-type":"application/json","x-request-id":t}})}catch{}let c=e.headers.get("x-idempotency-key")?.trim(),x=n.id??(c&&c.length>0?c:crypto.randomUUID()),q=Number(process.env.PER_IP_CONCURRENT_JOBS||3);if(!(0,p.C3)(i,q))return new Response(JSON.stringify({error:"too_many_jobs"}),{status:429,headers:{"content-type":"application/json","x-request-id":t}});let y=(0,p.Zn)(x);if(y)return new Response(JSON.stringify({id:x,status:y.status}),{status:200,headers:{"content-type":"application/json","x-request-id":t}});return(0,u.n4)()?(await (0,u.SP)({queueName:"battles",payload:{id:x,input:n}}),(0,p.Cq)(x,"battle",i),(0,p.gK)(x,{status:"running"})):((0,p.Cq)(x,"battle",i),(async()=>{(0,p.gK)(x,{status:"running"});let e=Number(process.env.REQUEST_TIMEOUT_MS||6e4),r=new AbortController,s=setTimeout(()=>r.abort("timeout"),e),o=Date.now();try{console.log(JSON.stringify({level:"info",msg:"battle_started",requestId:t,id:x,clientIp:i}));let e=await (0,l.m)({runId:x,agentId:n.agentId,provider:n.provider,model:n.model,systemPrompt:n.systemPrompt,goal:n.goal,messageLimit:n.messageLimit,userMessage:n.userMessage,maxTokens:n.maxTokens,temperature:n.temperature},void 0,r.signal);clearTimeout(s),(0,p.gK)(x,{status:"succeeded",data:e}),console.log(JSON.stringify({level:"info",msg:"battle_succeeded",requestId:t,id:x,durationMs:Date.now()-o}))}catch(r){clearTimeout(s);let e=String(r?.message??r);(0,p.gK)(x,{status:"failed",error:e}),console.warn(JSON.stringify({level:"warn",msg:"battle_failed",requestId:t,id:x,error:e,durationMs:Date.now()-o}))}})()),new Response(JSON.stringify({id:x,status:"pending"}),{status:202,headers:{"content-type":"application/json","x-request-id":t}})}catch{let e=globalThis.crypto?.randomUUID?.()??Math.random().toString(36).slice(2);return new Response(JSON.stringify({error:"internal_error"}),{status:500,headers:{"content-type":"application/json","x-request-id":e}})}}let q=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/battles/start/route",pathname:"/api/battles/start",filename:"route",bundlePath:"app/api/battles/start/route"},resolvedPagePath:"/Users/baramsalem/agents-repo/agents/src/agents_wars/web/app/api/battles/start/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:y,staticGenerationAsyncStorage:h,serverHooks:b}=q,f="/api/battles/start/route";function w(){return(0,a.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:h})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[948,691,214,608,505],()=>r(8252));module.exports=s})();