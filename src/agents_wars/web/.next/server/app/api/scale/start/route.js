"use strict";(()=>{var e={};e.id=857,e.ids=[857],e.modules={3524:e=>{e.exports=require("@prisma/client")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9491:e=>{e.exports=require("assert")},4300:e=>{e.exports=require("buffer")},2081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},9523:e=>{e.exports=require("dns")},2361:e=>{e.exports=require("events")},7147:e=>{e.exports=require("fs")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},8188:e=>{e.exports=require("module")},1808:e=>{e.exports=require("net")},7561:e=>{e.exports=require("node:fs")},4492:e=>{e.exports=require("node:stream")},2477:e=>{e.exports=require("node:stream/web")},2037:e=>{e.exports=require("os")},1017:e=>{e.exports=require("path")},5477:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},1576:e=>{e.exports=require("string_decoder")},4404:e=>{e.exports=require("tls")},6224:e=>{e.exports=require("tty")},7310:e=>{e.exports=require("url")},3837:e=>{e.exports=require("util")},1267:e=>{e.exports=require("worker_threads")},9796:e=>{e.exports=require("zlib")},4327:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>h,patchFetch:()=>w,requestAsyncStorage:()=>y,routeModule:()=>x,serverHooks:()=>f,staticGenerationAsyncStorage:()=>q});var s={};t.r(s),t.d(s,{POST:()=>g});var n=t(9303),a=t(8716),o=t(670),i=t(7410),p=t(7546),u=t(7349),d=t(5884),c=t(3538),l=t(6772);let m=i.z.object({runId:i.z.string().trim().optional(),agentId:i.z.string().trim().min(1),provider:i.z.enum(["openai","openrouter"]),model:i.z.string().trim().min(1),systemPrompt:i.z.string().trim().optional(),userMessage:i.z.string().trim().optional(),runs:i.z.coerce.number().int().positive().min(1).max(10),maxBudgetUsd:i.z.coerce.number().min(0).optional()});async function g(e){try{let r;let t=e.headers.get("x-forwarded-for")||"",s=t.split(",")[0]?.trim(),n=e?.ip||s||"local",a=await e.json(),o=m.safeParse(a);if(!o.success)return new Response(JSON.stringify({error:"invalid_body",details:o.error.flatten()}),{status:400,headers:{"content-type":"application/json"}});let i=o.data;if("number"==typeof i.maxBudgetUsd){try{await (0,l.Q)(i.provider,i.model)}catch{}let{usdIn:e,usdOut:t}=(0,l.U)(i.provider,i.model,{inputTokens:150*i.runs,outputTokens:300*i.runs});if((r=parseFloat((e+t).toFixed(4)))>i.maxBudgetUsd)return new Response(JSON.stringify({error:"budget_exceeded",estimatedUsd:r}),{status:400,headers:{"content-type":"application/json"}})}try{if(!await c._.agent.findUnique({where:{id:i.agentId}}))return new Response(JSON.stringify({error:"invalid_agent"}),{status:400,headers:{"content-type":"application/json"}})}catch{}let g=e.headers.get("x-idempotency-key")?.trim(),x=i.runId??(g&&g.length>0?g:crypto.randomUUID()),y=Number(process.env.PER_IP_CONCURRENT_JOBS||3);if(!(0,p.C3)(n,y))return new Response(JSON.stringify({error:"too_many_jobs"}),{status:429,headers:{"content-type":"application/json"}});let q=(0,p.Zn)(x);if(q)return new Response(JSON.stringify({id:x,status:q.status}),{status:200,headers:{"content-type":"application/json"}});return(0,u.n4)()?(await (0,u.SP)({queueName:"scale-tests",payload:{id:x,input:i}}),(0,p.Cq)(x,"scale",n),(0,p.gK)(x,{status:"running"})):((0,p.Cq)(x,"scale",n),(async()=>{(0,p.gK)(x,{status:"running"});try{let e=await (0,d.$)({runId:x,agentId:i.agentId,provider:i.provider,model:i.model,systemPrompt:i.systemPrompt,userMessage:i.userMessage,runs:i.runs});(0,p.gK)(x,{status:"succeeded",data:e})}catch(e){(0,p.gK)(x,{status:"failed",error:String(e?.message??e)})}})()),new Response(JSON.stringify({id:x,status:"pending",estimatedUsd:r}),{status:202,headers:{"content-type":"application/json"}})}catch{return new Response(JSON.stringify({error:"internal_error"}),{status:500,headers:{"content-type":"application/json"}})}}let x=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/scale/start/route",pathname:"/api/scale/start",filename:"route",bundlePath:"app/api/scale/start/route"},resolvedPagePath:"/Users/baramsalem/agents-repo/agents/src/agents_wars/web/app/api/scale/start/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:y,staticGenerationAsyncStorage:q,serverHooks:f}=x,h="/api/scale/start/route";function w(){return(0,o.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:q})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[948,691,214,608,505],()=>t(4327));module.exports=s})();